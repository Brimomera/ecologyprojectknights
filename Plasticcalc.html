<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plastic Footprint Calculator</title>
    <link rel="stylesheet" href="Plasticcalc.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body class="light">
    <div class="message-box-overlay" id="messageBoxOverlay">
        <div class="message-box-content">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxContent"></p>
            <button class="close-button" onclick="hideMessageBox()">Close</button>
        </div>
    </div>

    <div class="loading-spinner-overlay" id="loadingSpinnerOverlay">
        <div class="spinner"></div>
        <p>Calculating your footprint...</p>
    </div>

    <header>
        <h1 class="logo">EcoTech</h1>
        <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Mode">
            <span id="theme-icon">‚òÄÔ∏è</span>
        </button>
    </header>

    <main>
        <section class="hero-section fade-section">
            <div class="hero-content">
                <h2>Calculate Your Plastic Footprint</h2>
                <p>Understand your impact and discover ways to reduce plastic waste.</p>
            </div>
            <div class="hero-image">
                <img src="images/ocean-hero.jpg" alt="Clean ocean with a turtle">
            </div>
        </section>

        <hr>

        <section class="calculator-section fade-section">
            <h3>Enter Your Weekly/Monthly/Annual Consumption:</h3>
            <div class="calculator-grid">
                <div class="input-group">
                    <label for="bottles">Plastic Bottles (per week):</label>
                    <input type="number" id="bottles" min="0" placeholder="e.g., 5">
                </div>
                <div class="input-group">
                    <label for="bags">Plastic Bags (per week):</label>
                    <input type="number" id="bags" min="0" placeholder="e.g., 10">
                </div>
                <div class="input-group">
                    <label for="packaging">Plastic Packaging (per month in grams):</label>
                    <input type="number" id="packaging" min="0" placeholder="e.g., 500">
                </div>
                <div class="input-group">
                    <label for="straws">Plastic Straws (per day):</label>
                    <input type="number" id="straws" min="0" placeholder="e.g., 1">
                </div>
                <div class="input-group">
                    <label for="cutlery">Disposable Cutlery (per week):</label>
                    <input type="number" id="cutlery" min="0" placeholder="e.g., 2">
                </div>
                <div class="input-group">
                    <label for="containers">Plastic Containers (per week):</label>
                    <input type="number" id="containers" min="0" placeholder="e.g., 3">
                </div>
                <div class="input-group">
                    <label for="toys">Plastic Toys/Other Items (per year in grams):</label>
                    <input type="number" id="toys" min="0" placeholder="e.g., 200">
                </div>
            </div>
            <div class="button-group">
                <button id="calculateButton">Calculate Footprint</button>
                <button id="resetButton">Reset Results</button>
                <button id="clearAllButton">Clear All Inputs</button>
            </div>
        </section>

        <hr>

        <section id="result" class="result-section hidden fade-section">
            <h3>Your Plastic Footprint Summary:</h3>
            <p id="plasticConsumption"></p>
            <p id="reducePlasticTips"></p>

            <div class="impact-stats">
                <div class="stat-card">
                    <h4>Total Waste</h4>
                    <p><span id="totalWasteValue">0</span> kg/year</p>
                </div>
                <div class="stat-card">
                    <h4>Ocean Impact</h4>
                    <p>~<span id="oceanImpactValue">0</span> plastic bottles</p>
                </div>
                <div class="stat-card">
                    <h4>Bags Saved</h4>
                    <p><span id="bagsSavedValue">0</span> bags</p>
                </div>
                <div class="stat-card">
                    <h4>Microplastics</h4>
                    <p>~<span id="microplasticsValue">0</span> grams</p>
                </div>
                <div class="stat-card">
                    <h4>Simulated Recycling Rate</h4>
                    <p><span id="recyclingRateValue">0%</span></p>
                </div>
            </div>

            <h3 class="chart-title">Your Plastic Waste Breakdown</h3>
            <div class="chart-container">
                <canvas id="plasticChart"></canvas>
                <button id="toggleChartTypeBtn" class="toggle-chart-button" title="Toggle Chart Type">üìä</button>
            </div>
            <button id="shareResultsButton">Share My Results</button>
        </section>
    </main>

    <footer>
        <p id="footerText">&copy; 2023 EcoTech. All rights reserved.</p>
        <div id="likeCard" class="like-card">
            Thanks for using EcoTech!
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Declare isDark globally and initialize it.
        // It will be updated by initializeTheme based on localStorage.
        let isDark = false;

        // Get references to DOM elements
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');
        const themeToggleIcon = document.getElementById('theme-icon');
        const logo = document.querySelector('.logo');
        const sections = document.querySelectorAll('.fade-section');
        const calculateButton = document.getElementById('calculateButton');
        const resetButton = document.getElementById('resetButton');
        const clearAllButton = document.getElementById('clearAllButton');
        const resultSection = document.getElementById('result');
        const plasticConsumptionDiv = document.getElementById('plasticConsumption');
        const reducePlasticTipsDiv = document.getElementById('reducePlasticTips');
        const totalWasteValue = document.getElementById('totalWasteValue');
        const oceanImpactValue = document.getElementById('oceanImpactValue');
        const bagsSavedValue = document.getElementById('bagsSavedValue');
        const microplasticsValue = document.getElementById('microplasticsValue');
        const recyclingRateValue = document.getElementById('recyclingRateValue');
        const toggleChartTypeBtn = document.getElementById('toggleChartTypeBtn');
        const shareResultsButton = document.getElementById('shareResultsButton');
        const footerText = document.getElementById('footerText');
        const likeCard = document.getElementById('likeCard');
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const loadingSpinnerOverlay = document.getElementById('loadingSpinnerOverlay');

        let plasticChart = null; // Variable to hold the Chart.js instance
        let currentChartTypeIndex = 0; // Index for current chart type
        const chartTypes = ['doughnut', 'bar', 'line']; // Available chart types
        let lastCalculatedData = null; // Stores the last calculated data for chart updates
        let totalPlasticWasteKg = 0; // Stores the total plastic waste

        /**
         * @function showMessageBox
         * @description Displays a custom message box with a title and content.
         * @param {string} title - The title of the message box.
         * @param {string} message - The content message to display.
         */
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxOverlay.classList.add('visible');
        }

        /**
         * @function hideMessageBox
         * @description Hides the custom message box.
         */
        function hideMessageBox() {
            messageBoxOverlay.classList.remove('visible');
        }

        /**
         * @function showLoadingSpinner
         * @description Displays the loading spinner overlay.
         */
        function showLoadingSpinner() {
            loadingSpinnerOverlay.classList.add('visible');
        }

        /**
         * @function hideLoadingSpinner
         * @description Hides the loading spinner overlay.
         */
        function hideLoadingSpinner() {
            loadingSpinnerOverlay.classList.remove('visible');
        }

        /**
         * @function initializeTheme
         * @description Initializes the theme based on localStorage preference.
         */
        function initializeTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                isDark = true;
                body.classList.add('dark');
                // Remove 'light' class if it exists to ensure consistency, though CSS primarily relies on 'dark'
                body.classList.remove('light');
                if (themeToggleIcon) {
                    themeToggleIcon.textContent = 'üåë';
                }
            } else {
                isDark = false;
                body.classList.remove('dark'); // Ensure 'dark' class is removed if theme is light
                // Add 'light' class as initial class in HTML, or rely on default body styles
                body.classList.add('light');
                if (themeToggleIcon) {
                    themeToggleIcon.textContent = '‚òÄÔ∏è';
                }
            }
        }

        /**
         * @function toggleTheme
         * @description Toggles between light and dark themes and updates localStorage.
         */
        function toggleTheme() {
            isDark = !isDark;
            body.classList.toggle('dark', isDark);
            // The 'light' class toggle is largely redundant if base body styles are light,
            // as CSS targets 'body.dark'. Keeping 'light' for explicit state management.
            body.classList.toggle('light', !isDark);
            themeToggleIcon.textContent = isDark ? 'üåë' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // If chart exists and data is available, update chart colors
            if (plasticChart && lastCalculatedData) {
                const rootStyles = getComputedStyle(document.documentElement);
                const neonBlue = rootStyles.getPropertyValue('--neon-blue').trim();
                const neonPurple = rootStyles.getPropertyValue('--neon-purple').trim();
                const neonGreen = rootStyles.getPropertyValue('--neon-green').trim();
                const neonYellow = rootStyles.getPropertyValue('--neon-yellow').trim();
                const textColor = rootStyles.getPropertyValue('--text').trim();
                const glassBgColor = rootStyles.getPropertyValue('--glass-bg').trim();
                updateChart(lastCalculatedData, chartTypes[currentChartTypeIndex], neonBlue, neonPurple, neonGreen, neonYellow, textColor, glassBgColor);
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initializeTheme);

        // Event listener for logo click to navigate to home
        logo.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Intersection Observer for fade-in animations on sections
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1 }); // Trigger when 10% of the section is visible

        // Observe all sections with 'fade-section' class
        document.querySelectorAll('.fade-section').forEach((section) => {
            observer.observe(section);
        });

        // Event Listeners for calculator buttons
        calculateButton.addEventListener('click', calculatePlasticFootprint);
        resetButton.addEventListener('click', resetCalculator);
        clearAllButton.addEventListener('click', clearAllInputs);
        toggleChartTypeBtn.addEventListener('click', toggleChartType);
        shareResultsButton.addEventListener('click', shareResults);

        /**
         * @function calculatePlasticFootprint
         * @description Calculates the user's estimated annual plastic waste based on inputs.
         * Displays results, a chart, and tips.
         */
        function calculatePlasticFootprint() {
            showLoadingSpinner(); // Show loading spinner

            // Simulate a delay for calculation for better UX
            setTimeout(() => {
                // Get input values, default to 0 if empty or invalid
                const bottles = parseFloat(document.getElementById('bottles').value) || 0;
                const bags = parseFloat(document.getElementById('bags').value) || 0;
                const packaging = parseFloat(document.getElementById('packaging').value) || 0;
                const straws = parseFloat(document.getElementById('straws').value) || 0;
                const cutlery = parseFloat(document.getElementById('cutlery').value) || 0;
                const containers = parseFloat(document.getElementById('containers').value) || 0;
                const toys = parseFloat(document.getElementById('toys').value) || 0;

                // Input validation: ensure no negative values
                if (bottles < 0 || bags < 0 || packaging < 0 || straws < 0 || cutlery < 0 || containers < 0 || toys < 0) {
                    hideLoadingSpinner();
                    showMessageBox("Invalid Input", "Please enter non-negative values for plastic consumption.");
                    return;
                }

                // Convert weekly/daily/monthly usage to annual kilograms
                // (Approximate weights: bottle ~20g, bag ~5g, straw ~2g, cutlery ~5g, container ~30g)
                const bottlesPerYear = bottles * 52 * 0.02; // kg
                const bagsPerYear = bags * 52 * 0.005; // kg
                const packagingPerYear = packaging * 12 / 1000; // kg
                const strawsPerYear = straws * 365 * 0.002; // kg
                const cutleryPerYear = cutlery * 52 * 0.005; // kg
                const containersPerYear = containers * 52 * 0.03; // kg
                const toysPerYear = toys * 12 / 1000; // kg

                // Calculate total plastic waste
                totalPlasticWasteKg = bottlesPerYear + bagsPerYear + packagingPerYear + strawsPerYear + cutleryPerYear + containersPerYear + toysPerYear;

                // Store data for chart updates
                lastCalculatedData = {
                    bottles: bottlesPerYear,
                    bags: bagsPerYear,
                    packaging: packagingPerYear,
                    straws: strawsPerYear,
                    cutlery: cutleryPerYear,
                    containers: containersPerYear,
                    toys: toysPerYear
                };

                // Calculate impact metrics
                const KG_PER_STANDARD_BOTTLE = 0.02; // 20 grams per bottle
                const oceanImpactBottles = Math.ceil(totalPlasticWasteKg / KG_PER_STANDARD_BOTTLE); // Rounded up

                const averageBagsPerYear = 300; // Example average bags used per year
                const currentBagsPerYear = bags * 52;
                const bagsSaved = Math.max(0, averageBagsPerYear - currentBagsPerYear); // Cannot be negative

                const MICROPLASTIC_CONVERSION_FACTOR = 0.005; // 0.5% of plastic waste becomes microplastic
                const microplasticsGeneratedGrams = (totalPlasticWasteKg * 1000 * MICROPLASTIC_CONVERSION_FACTOR).toFixed(2);

                const simulatedRecyclingRate = (Math.random() * 20 + 20).toFixed(0); // Random rate between 20-40%

                // Get CSS variable values for chart colors (to adapt to theme)
                const rootStyles = getComputedStyle(document.documentElement);
                const neonBlue = rootStyles.getPropertyValue('--neon-blue').trim();
                const neonPurple = rootStyles.getPropertyValue('--neon-purple').trim();
                const neonGreen = rootStyles.getPropertyValue('--neon-green').trim();
                const neonYellow = rootStyles.getPropertyValue('--neon-yellow').trim();
                const textColor = rootStyles.getPropertyValue('--text').trim();
                const glassBgColor = rootStyles.getPropertyValue('--glass-bg').trim();

                // Update consumption summary text
                plasticConsumptionDiv.textContent = `Your estimated annual plastic waste is: ${totalPlasticWasteKg.toFixed(2)} kg üóëÔ∏è`;
                plasticConsumptionDiv.classList.remove('hidden');

                // Generate a random tip for reducing plastic waste
                const tips = [
                    "Carry a reusable water bottle and coffee cup.",
                    "Always use reusable shopping bags.",
                    "Choose products with minimal or no plastic packaging, especially fresh produce.",
                    "Say no to plastic straws, cutlery, and takeout containers; bring your own reusable set.",
                    "Support businesses that prioritize plastic reduction and sustainable packaging.",
                    "Participate in local beach or park clean-up drives.",
                    "Recycle plastic properly in your area, understanding local guidelines.",
                    "Avoid single-use plastics wherever possible, including disposable razors and pens.",
                    "Buy in bulk to reduce packaging waste.",
                    "Consider making your own cleaning products to avoid plastic bottles.",
                    "Repair items instead of replacing them, especially electronics and toys.",
                    "Educate others on the importance of reducing plastic waste."
                ];
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                reducePlasticTipsDiv.textContent = `You can do this to reduce plastic: ${randomTip} üåä`;
                reducePlasticTipsDiv.classList.remove('hidden');

                // Update impact statistics values
                totalWasteValue.textContent = totalPlasticWasteKg.toFixed(2);
                oceanImpactValue.textContent = oceanImpactBottles;
                bagsSavedValue.textContent = bagsSaved;
                microplasticsValue.textContent = microplasticsGeneratedGrams;
                recyclingRateValue.textContent = `${simulatedRecyclingRate}%`;

                // Show and animate the result section
                resultSection.classList.remove('hidden');
                void resultSection.offsetWidth; // Trigger reflow for animation
                resultSection.classList.add('visible');

                // Update the chart with new data
                updateChart(lastCalculatedData, chartTypes[currentChartTypeIndex], neonBlue, neonPurple, neonGreen, neonYellow, textColor, glassBgColor);

                hideLoadingSpinner(); // Hide loading spinner
            }, 1000); // Simulate 1 second loading time
        }

        /**
         * @function resetCalculator
         * @description Resets the result section and chart to their initial states.
         */
        function resetCalculator() {
            if (plasticChart) {
                plasticChart.destroy(); // Destroy existing chart instance
                plasticChart = null;
            }
            lastCalculatedData = null;
            totalPlasticWasteKg = 0;
            plasticConsumptionDiv.textContent = '';
            reducePlasticTipsDiv.textContent = '';
            totalWasteValue.textContent = '0';
            oceanImpactValue.textContent = '0';
            bagsSavedValue.textContent = '0';
            microplasticsValue.textContent = '0';
            recyclingRateValue.textContent = '0%';

            // Hide and animate out the result section
            resultSection.classList.remove('visible');
            resultSection.classList.add('hidden');
        }

        /**
         * @function clearAllInputs
         * @description Clears all input fields and then resets the calculator.
         */
        function clearAllInputs() {
            document.getElementById('bottles').value = '';
            document.getElementById('bags').value = '';
            document.getElementById('packaging').value = '';
            document.getElementById('straws').value = '';
            document.getElementById('cutlery').value = '';
            document.getElementById('containers').value = '';
            document.getElementById('toys').value = '';

            resetCalculator(); // Call reset to clear results and chart
        }

        /**
         * @function toggleChartType
         * @description Cycles through different chart types (doughnut, bar, line).
         */
        function toggleChartType() {
            currentChartTypeIndex = (currentChartTypeIndex + 1) % chartTypes.length;
            if (lastCalculatedData) {
                // Get current theme colors to update chart
                const rootStyles = getComputedStyle(document.documentElement);
                const neonBlue = rootStyles.getPropertyValue('--neon-blue').trim();
                const neonPurple = rootStyles.getPropertyValue('--neon-purple').trim();
                const neonGreen = rootStyles.getPropertyValue('--neon-green').trim();
                const neonYellow = rootStyles.getPropertyValue('--neon-yellow').trim();
                const textColor = rootStyles.getPropertyValue('--text').trim();
                const glassBgColor = rootStyles.getPropertyValue('--glass-bg').trim();
                updateChart(lastCalculatedData, chartTypes[currentChartTypeIndex], neonBlue, neonPurple, neonGreen, neonYellow, textColor, glassBgColor);
            }
        }

        /**
         * @function updateChart
         * @description Creates or updates the Chart.js graph with new data and type.
         * @param {object} data - The data object containing plastic waste breakdown.
         * @param {string} type - The type of chart to display ('doughnut', 'bar', 'line').
         * @param {string} neonBlue - CSS variable for neon blue color.
         * @param {string} neonPurple - CSS variable for neon purple color.
         * @param {string} neonGreen - CSS variable for neon green color.
         * @param {string} neonYellow - CSS variable for neon yellow color.
         * @param {string} textColor - CSS variable for text color.
         * @param {string} glassBgColor - CSS variable for glass background color.
         */
        function updateChart(data, type, neonBlue, neonPurple, neonGreen, neonYellow, textColor, glassBgColor) {
            const ctx = document.getElementById('plasticChart').getContext('2d');

            // Destroy existing chart before creating a new one
            if (plasticChart) {
                plasticChart.destroy();
            }

            const chartLabels = ['Bottles', 'Bags', 'Packaging', 'Straws', 'Cutlery', 'Containers', 'Other Items'];
            const chartDataValues = [data.bottles, data.bags, data.packaging, data.straws, data.cutlery, data.containers, data.toys];

            const chartData = {
                labels: chartLabels,
                datasets: [{
                    label: 'Plastic Waste (kg/year)',
                    data: chartDataValues,
                    backgroundColor: [
                        neonBlue,
                        neonGreen,
                        neonPurple,
                        neonYellow,
                        'rgba(255, 99, 132, 0.8)', // Fallback/additional colors
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ],
                    borderColor: [
                        neonBlue.replace('0.8)', '1)'), // Solid border for colors
                        neonGreen.replace('0.8)', '1)'),
                        neonPurple.replace('0.8)', '1)'),
                        neonYellow.replace('0.8)', '1)'),
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 2,
                    fill: type === 'line' ? true : false, // Fill area for line chart
                    tension: type === 'line' ? 0.4 : 0 // Smooth lines for line chart
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false, // Allow canvas to resize freely
                scales: {
                    y: {
                        beginAtZero: true,
                        display: type !== 'doughnut', // Hide Y-axis for doughnut chart
                        title: {
                            display: type !== 'doughnut',
                            text: 'Plastic Waste (kg/year)',
                            color: textColor
                        },
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)' // Light grid lines
                        }
                    },
                    x: {
                        display: type !== 'doughnut', // Hide X-axis for doughnut chart
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)' // Light grid lines
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textColor // Legend text color
                        }
                    },
                    title: {
                        display: false, // Title handled by H3 above chart
                        text: 'Your Plastic Waste Breakdown',
                        font: {
                            size: 18,
                            color: textColor
                        },
                        color: textColor
                    },
                    tooltip: {
                        backgroundColor: glassBgColor, // Tooltip background matches glassmorphism
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true
                    }
                }
            };

            // Create new Chart.js instance
            plasticChart = new Chart(ctx, {
                type: type,
                data: chartData,
                options: chartOptions
            });
        }

        /**
         * @function shareResults
         * @description Copies the plastic footprint summary to the clipboard.
         * Uses document.execCommand('copy') for broader compatibility in iframes.
         */
        function shareResults() {
            const totalWasteFormatted = totalPlasticWasteKg.toFixed(2);
            const oceanImpact = oceanImpactValue.textContent;
            const message = `My estimated annual plastic waste is ${totalWasteFormatted} kg, which is equivalent to ${oceanImpact} plastic bottles in the ocean! Let's reduce our plastic footprint together. #EcoTech #PlasticWaste`;

            // Use document.execCommand('copy') for clipboard functionality
            if (document.execCommand) {
                const textarea = document.createElement('textarea');
                textarea.value = message;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox("Results Copied!", "Your plastic footprint summary has been copied to your clipboard. Now go share it!");
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showMessageBox("Copy Failed", "Could not copy to clipboard. Please copy the text manually:\n\n" + message);
                }
                document.body.removeChild(textarea);
            } else {
                showMessageBox("Copy Not Supported", "Your browser does not support automatic clipboard copying. Please copy the text manually:\n\n" + message);
            }
        }

        // Event listener for footer text to show "like card"
        footerText.addEventListener('click', () => {
            likeCard.classList.add('visible');
            setTimeout(() => {
                likeCard.classList.remove('visible');
            }, 3000); // Hide after 3 seconds
        });
    </script>
</body>
</html>
